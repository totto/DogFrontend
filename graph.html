<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart","table"]});
    </script>
    <style>
      body {background-color: #ddd;}
      .container {background-color: #fff;}
      .bottom { vertical-align: bottom !important; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>RAS Dashboard</h1>
      </div>
      <div class="row">
        <div class="col-md-12">
          <form class="form-inline" role="form" id="graphForm">
            <div class="form-group">
              <label for="breed">Rase</label>
              <input type="text" class="form-control" name="breed" id="breed" value="Rottweiler">
            </div>
            <div class="form-group">
              <label for="minYear">Fra år</label>
              <input type="number" class="form-control" placeholder="Fra år" id="minYear" value="2000" size="4"/>
            </div>
            <div class="form-group">
              <label for="maxYear">Til år</label>
              <input type="number" class="form-control" placeholder="Til år" id="maxYear" value="2010" size="4"/>
            </div>
            <div class="form-group">
              <label for="generations">Generasjoner</label>
              <select name="generations" id="generations" class="form-control">
                <option value="3">3 ledd</option>
                <option value="4">4 ledd</option>
                <option value="5">5 ledd</option>
                <option value="6">6 ledd</option>
                <option value="7">7 ledd</option>
                <option value="8" selected>8 ledd</option>
                <option value="9">9 ledd</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn btn-primary" type="submit">Show graph</button>
            </div>
          </form>
        </div>

      </div>
      <div class="row" id="graphcontainer">
      </div>
    </div>

    <script>
      (function(){

        // sname: object.sname.percentiles
        function graphObject(title, url, sContainer) {
          return {
            title: title,
            url: url,
            statisticsContainer: sContainer,
            divId: function() {
              return this.title.replace(/\s+/g,'');
            },
            storeData: function(data, year){
              this.dataTable.addRow([
                '' + year,
                data[this.statisticsContainer].percentile50,
                data[this.statisticsContainer].percentile10,
                data[this.statisticsContainer].percentile25,
                data[this.statisticsContainer].percentile75,
                data[this.statisticsContainer].percentile90
              ]);
              this.dataTable.sort(0);
              var chart = new google.visualization['LineChart']( document.getElementById(this.divId()) );
              chart.draw(this.dataTable, { 
                title: this.title, 
                curveType: 'function',
                height: 300,
                lineWidth: 2,
                intervals: { style: 'area' },
                interval: {
                  i2: { 
                    style: 'points',
                    pointSize: 10
                  }
                }
              });
            },
            dataTable: {},
            init: function() {
              this.dataTable = new google.visualization.DataTable();
              this.dataTable.addColumn('string', 'År');
              this.dataTable.addColumn('number', 'Snitt');
              this.dataTable.addColumn({id:'i2', type:'number', role:'interval', legend: '10'});
              this.dataTable.addColumn({id:'i1', type:'number', role:'interval', legend: '25'});
              this.dataTable.addColumn({id:'i1', type:'number', role:'interval', legend: '75'});
              this.dataTable.addColumn({id:'i2', type:'number', role:'interval', legend: '90'});
            }
          }
        }
        var graphs = [
          new graphObject('Stamtavlekompletthet','/dogpopulation/graph/pedigreecompleteness', 'pedigreeCompletenessStatistics'),
          new graphObject('Innavl','/dogpopulation/graph/inbreeding', 'statistics')
        ];
        //?generations=6&breed=Rottweiler&minYear=1999&maxYear=2001

        function initiateGraphs(g){
          var html = '';
          for(var i=0;i<g.length;i++){
            html += '<div id="'+g[i].divId()+'" class="col-md-12"><h3>'+g[i].title+'</h3></div>';
            g[i].init();
          }
          $('#graphcontainer').append(html);
        }

        initiateGraphs(graphs);

        $('#graphForm').submit(function(e){
          console.log('Submitting form...');
          e.preventDefault();
          var minYear = $('#minYear').val();
          var maxYear = $('#maxYear').val();
          for(var i=0;i<graphs.length;i++){
            console.log('Getting data for: ', graphs[i].title);
            graphs[i].init();
            for(var year=minYear; year<=maxYear; year++) {
              $.ajax({
                graph: graphs[i],
                year: year,
                url: graphs[i].url,
                data: $(this).serialize()+'&minYear='+year+'&maxYear='+year
              }).success(function(data){
                this.graph.storeData(data,this.year);
              });
            }
          }
        })

      }());
    </script>

    <script>
      var customData = {
        title: 'Egendefinert graf',
        type: 'LineChart',
        query: '',
        year: 2013,
        yeartype: 'born',
        range: 1,
        getYearSpan: function(year) {
          return '&fq='+this.yeartype+':['+year+'-01-01T00:00:00Z TO '+year+'-12-31T23:59:59Z]';
        },
        getResult: function(response, year) {
          return response.numFound;
        },
        data: [
          ['År', '']
        ]
      }

      /*$('#graphForm ').submit(function(event) {
        document.getElementById('customgraph').innerHTML = '';
        customData.query = document.getElementById('query').value;
        customData.title = customData.query;
        customData.range = document.getElementById('range').value;
        customData.yeartype = document.getElementById('yeartype').value;
        renderData(customData);
        drawChart(customData, 'customgraph', 'col-md-12');
        event.preventDefault();
      });*/
    </script>
  </body>
</html>